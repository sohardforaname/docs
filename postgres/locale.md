# Postgresql的字符集管理

Postgresql为了支持多种编码的文字显示，实现了对UTF-8和Unicode等编码的显示。Postgres允许使用不同的服务器和客户端编码，来应对使用不同语言的人群的需求。
在Postgresql中，不同的字符集通过创建conversion，调用转换函数进行转换，转换函数也会同时调用映射表实现字符的替换。

## 字符的存储和表示

字符的本质是编码，由于客户端与服务端的编码可以不同，因此来自客户端的某段文本（字节序列）使用的是客户端的编码，我们需要转换成服务端的编码进行存储。
因此服务端存储某个字符时，存储的是这个字符在服务端的编码下的二进制代码。

同理，字符由服务端发往客户端时，也需要先进行转换，得到这个字符在客户端下的编码，再把二进制序列发送至客户端，客户端就会基于编码绘制字符并显示。
因此，只要有转换表，不同的字符编码方案可以进行互相转换

## 如何在Postgres中加入一个新的字符集

首先我们需要转换表，转换表通常是一个.map文件，然后在.map中我们就可以通过定义一个转换数组来实现，数组类型分别是pg_utf_to_local和pg_local_to_utf。
数组按照这两个结构体类型的第一个字段排序来实现快速的二分查找。一般来说，大多数字符只有到unicode字符编码的转换表，所以我们在添加到.map文件时，需要手动处理unicode编码到对应的utf8编码。

第二步是准备实现一个postgres的内置函数实现转换，这个函数通常是xxx_to_xxx的形式，放在mb文件夹下点对应转换文件夹的xxx_to_xxx.cpp中，
这里的函数参考别的转换函数即可。

第三步是在pg_wchar.h的pg_enc枚举类型中添加对应的枚举类型，并在chklocale.cpp中的encoding_match_list中添加字符串表示的字符编码别名到枚举的映射。
在wchar.cpp的pg_wchar_table中按照pg_enc中的顺序添加对应编码的函数集。在pg_enc2name_tbl中按顺序添加DEFNAME的条目，在pg_encname_tbl中添加编码的名字即可。

第四步就可以开始测试，常见的测试方法是：把服务端设置为对应的新编码，然后客户端设置成UTF-8编码，我们把UTF-8编码的字节序列作为raw类型传到服务端，执行raw_to_varchar等方法，
然后检查返回的这个varchar的字节序列，然后反向测试，即把服务端和客户端的编码对调，然后输入新编码的字节序列，获取UTF-8编码的varchar字符串的字节序列。
对这些字节序列我们使用手上的转换表检查即可。这里可以使用python脚本自动化完成。

最后就是在一台拥有该编码的机器上进行实际测试，满足使用需求即可。